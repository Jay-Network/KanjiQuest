name: KanjiQuest iOS Build & TestFlight

on:
  push:
    branches: [main]
    paths:
      - 'shared-core/**'
      - 'shared-japanese/**'
      - 'ios-app/**'
      - '.github/workflows/kanjiquest-ios.yml'
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  BUNDLE_ID: 'com.jworks.kanjiquest.ipad'
  SCHEME: 'KanjiQuest'
  TEAM_ID: '27943BGKL7'
  PROFILE_NAME: 'KanjiQuest iPad App Store'

jobs:
  build-xcframework:
    name: Build KMP XCFrameworks
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - run: chmod +x gradlew

      - name: Build SharedCore XCFramework
        run: ./gradlew :shared-core:assembleSharedCoreReleaseXCFramework

      - name: Build SharedJapanese XCFramework
        run: ./gradlew :shared-japanese:assembleSharedJapaneseReleaseXCFramework

      - uses: actions/upload-artifact@v4
        with:
          name: xcframeworks
          path: |
            shared-core/build/XCFrameworks/release/
            shared-japanese/build/XCFrameworks/release/

  build-ios:
    name: Build & Upload to TestFlight
    runs-on: macos-14
    needs: build-xcframework
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: xcframeworks

      - name: Verify and stage XCFrameworks
        run: |
          echo "=== Workspace contents ==="
          find . -name "*.xcframework" -type d
          echo "=== Checking expected paths ==="
          ls -d shared-core/build/XCFrameworks/release/SharedCore.xcframework || { echo "SharedCore.xcframework NOT FOUND"; exit 1; }
          echo "SharedCore.xcframework found"
          echo "=== Copying to ios-app/Frameworks/ ==="
          mkdir -p ios-app/Frameworks
          cp -R shared-core/build/XCFrameworks/release/SharedCore.xcframework ios-app/Frameworks/
          if [ -d "shared-japanese/build/XCFrameworks/release/SharedJapanese.xcframework" ]; then
            cp -R shared-japanese/build/XCFrameworks/release/SharedJapanese.xcframework ios-app/Frameworks/
            echo "SharedJapanese.xcframework copied"
          fi
          ls -la ios-app/Frameworks/

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.0.app || sudo xcode-select -s /Applications/Xcode.app

      - name: Install xcodegen
        run: brew install xcodegen

      # --- Signing Setup ---
      - name: Install certificate and provisioning profile
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Install provisioning profile
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o "$PP_PATH"

          # Extract UUID and Name from provisioning profile
          PP_PLIST=$(security cms -D -i "$PP_PATH")
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$PP_PLIST")
          PP_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" /dev/stdin <<< "$PP_PLIST")
          echo "PP_UUID=$PP_UUID" >> "$GITHUB_ENV"
          echo "PP_NAME=$PP_NAME" >> "$GITHUB_ENV"

          # Install profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"$PP_UUID".mobileprovision

          echo "Certificate and provisioning profile installed successfully"
          echo "Profile UUID: $PP_UUID"
          echo "Profile Name: $PP_NAME"

      # --- Build ---
      - name: Create xcconfig
        working-directory: ios-app
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat > KanjiQuest.xcconfig << EOF
          SUPABASE_URL = ${SUPABASE_URL}
          SUPABASE_ANON_KEY = ${SUPABASE_ANON_KEY}
          GEMINI_API_KEY = ${GEMINI_API_KEY}
          DEVELOPMENT_TEAM = 27943BGKL7
          EOF

      - name: Generate Xcode project
        working-directory: ios-app
        run: xcodegen

      - name: Create ExportOptions.plist
        working-directory: ios-app
        run: |
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>27943BGKL7</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.jworks.kanjiquest.ipad</key>
              <string>${PP_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF
          echo "ExportOptions.plist profile name: $PP_NAME"

      - name: Archive
        working-directory: ios-app
        run: |
          set -o pipefail
          xcodebuild archive \
            -project KanjiQuest.xcodeproj \
            -scheme KanjiQuest \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/KanjiQuest.xcarchive \
            DEVELOPMENT_TEAM=27943BGKL7 \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="$PP_UUID" \
            FRAMEWORK_SEARCH_PATHS="$(pwd)/Frameworks" \
            | xcpretty

      - name: Verify archive
        working-directory: ios-app
        run: |
          ls -la build/KanjiQuest.xcarchive/Products/Applications/ || { echo "Archive failed - no .app found"; exit 1; }

      - name: Export IPA
        working-directory: ios-app
        run: |
          set -o pipefail
          xcodebuild -exportArchive \
            -archivePath build/KanjiQuest.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/export \
            | xcpretty
          ls -la build/export/*.ipa || { echo "Export failed - no IPA found"; exit 1; }

      # --- Upload to TestFlight ---
      - name: Install App Store Connect API key
        env:
          API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo -n "$API_KEY_BASE64" | base64 --decode -o ~/private_keys/AuthKey_"$API_KEY_ID".p8

      - name: Upload to TestFlight
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        working-directory: ios-app
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file build/export/KanjiQuest.ipa \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$API_ISSUER_ID"

      # --- Artifacts ---
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: KanjiQuest-iPad.ipa
          path: ios-app/build/export/KanjiQuest.ipa

      # --- Cleanup ---
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
          rm -f ~/private_keys/AuthKey_*.p8 2>/dev/null || true
