name: Brush Test Build & TestFlight

on:
  push:
    branches: [main]
    paths:
      - 'ios-app-brush-test/**'
      - '.github/workflows/brush-test.yml'
  workflow_dispatch:

jobs:
  build-brush-test:
    name: Build Brush Test & Upload to TestFlight
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app || sudo xcode-select -s /Applications/Xcode_16.1.app || sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app
          xcodebuild -version

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Install certificate and provisioning profile
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o "$PP_PATH"

          PP_PLIST=$(security cms -D -i "$PP_PATH")
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$PP_PLIST")
          PP_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" /dev/stdin <<< "$PP_PLIST")
          echo "PP_UUID=$PP_UUID" >> "$GITHUB_ENV"
          echo "PP_NAME=$PP_NAME" >> "$GITHUB_ENV"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"$PP_UUID".mobileprovision

      - name: Generate Xcode project
        working-directory: ios-app-brush-test
        run: xcodegen

      - name: Create ExportOptions.plist
        working-directory: ios-app-brush-test
        env:
          TEAM_ID: '27943BGKL7'
        run: |
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.jworks.kanjiquest.ipad</key>
              <string>${PP_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF

      - name: Archive
        working-directory: ios-app-brush-test
        run: |
          set -o pipefail
          xcodebuild archive \
            -project BrushTest.xcodeproj \
            -scheme BrushTest \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/BrushTest.xcarchive \
            DEVELOPMENT_TEAM=27943BGKL7 \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="$PP_UUID" \
            ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=YES \
            2>&1 | tee /tmp/xcodebuild.log | xcpretty || {
              echo "=== Raw xcodebuild error output ==="
              tail -40 /tmp/xcodebuild.log
              exit 1
            }

      - name: Export IPA
        working-directory: ios-app-brush-test
        run: |
          set -o pipefail
          xcodebuild -exportArchive \
            -archivePath build/BrushTest.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/export \
            | xcpretty
          ls -la build/export/*.ipa || { echo "Export failed - no IPA found"; exit 1; }

      - name: Install App Store Connect API key
        env:
          API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo -n "$API_KEY_BASE64" | base64 --decode -o ~/private_keys/AuthKey_"$API_KEY_ID".p8

      - name: Upload to TestFlight
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        working-directory: ios-app-brush-test
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file build/export/BrushTest.ipa \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$API_ISSUER_ID"

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
          rm -f ~/private_keys/AuthKey_*.p8 2>/dev/null || true
